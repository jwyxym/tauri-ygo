name: build tauri-ygo

on:
  push:
    branches:
      - main
    
jobs:
  build-android:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install wget and unzip
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        choco install wget unzip -y

    - name: Install Java21
      shell: cmd
      run: |
        wget https://download.oracle.com/java/21/latest/jdk-21_windows-x64_bin.zip
        unzip jdk-21_windows-x64_bin.zip -d java21
    
    - name: Rename Java21Dir
      shell: pwsh
      run: |
        $folders = Get-ChildItem -Path './java21' -Directory

        if ($folders.Count -gt 0) {
          $oldPath = Join-Path './java21' $folders[0].Name
          Rename-Item -Path $oldPath -NewName "java"
        }

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install Android sdk
      shell: cmd
      run: |
        mkdir android-sdk
        cd android-sdk
        mkdir platform-tools
        wget https://dl.google.com/android/repository/commandlinetools-win-13114758_latest.zip
        set ANDROID_SDK_ROOT=%cd%
        mkdir cmdline-tools
        unzip commandlinetools-win-13114758_latest.zip -d cmdline-tools
        cd cmdline-tools
        ren cmdline-tools latest
        .\latest\bin\sdkmanager.bat "platform-tools" "build-tools;34.0.0" "platforms;android-34"

    - name: Install Android ndk r27
      shell: cmd
      run: |
        wget https://googledownloads.cn/android/repository/android-ndk-r27d-windows.zip
        unzip android-ndk-r27d-windows.zip

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: 1.88.0

    - name: Write Tauri Config
      shell: cmd
      run: |
        cd .ci
        python tauri.conf.json.py android

    - name: NPM Init
      shell: cmd
      run: |
        npm install
    
    - name: Android Init
      shell: cmd
      env:
        JAVA_HOME: ${{ github.workspace }}\java21\java
        ANDROID_HOME: ${{ github.workspace }}\android-sdk
        NDK_HOME: ${{ github.workspace }}\android-ndk-r27d
      run: |
        npm run tauri android init

    - name: Android copy
      run: |
        npm run copy

    - name: Android icon
      run: |
        wget https://code.moenext.com/mycard/hd-arts/-/raw/master/arts/84477320.jpg
        npm run tauri icon -p 84477320.jpg

    - name: Android build
      shell: cmd
      env:
        JAVA_HOME: ${{ github.workspace }}\java21\java
        NDK_HOME: ${{ github.workspace }}\android-ndk-r27d
      run: |
        npm run tauri android build

    - name: Decode Keystore File
      shell: pwsh
      run: |
        $base64String = "${{ secrets.KEYSTORE_FILE }}"
        $cleanBase64 = $base64String -replace "`r`n|`n|\s", ""
        $bytes = [System.Convert]::FromBase64String($cleanBase64)
        [System.IO.File]::WriteAllBytes("tauri-ygo.jks", $bytes)

    - name: Sign apk
      shell: cmd
      run: |
        mkdir build
        "%ANDROID_HOME%\build-tools\34.0.0\apksigner.bat" sign --ks ./tauri-ygo.jks --ks-key-alias ${{ secrets.KEY_ALIAS }} --key-pass pass:${{ secrets.KEYSTORE_PASSWORD }} --ks-pass pass:${{ secrets.KEYSTORE_PASSWORD }} --out .\build\tauri-ygo.apk .\src-tauri\gen\android\app\build\outputs\apk\universal\release\app-universal-release-unsigned.apk

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: tauri-ygo.apk
        path: .\build\tauri-ygo.apk

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: 1.88.0

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'


    - name: Install wget and unzip
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        choco install wget unzip -y

    - name: Install 7zip
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        choco install 7zip -y

    - name: Download Assets
      shell: cmd
      run: |
        cd .ci
        wget -O ygopro-database.zip https://github.com/mycard/ygopro-database/archive/refs/heads/master.zip
        unzip ygopro-database.zip
        mkdir cdb
        mkdir strings
        copy ygopro-database-master\locales\zh-CN\cards.cdb cdb\cards-zh-CN.cdb
        copy ygopro-database-master\locales\ko-KR\cards.cdb cdb\cards-ko-KR.cdb
        copy ygopro-database-master\locales\ja-JP\cards.cdb cdb\cards-ja-JP.cdb
        copy ygopro-database-master\locales\en-US_mdpro3\cards.cdb cdb\cards-en-US.cdb
        copy ygopro-database-master\locales\zh-CN\strings.conf strings\strings-zh-CN.conf
        copy ygopro-database-master\locales\ko-KR\strings.conf strings\strings-ko-KR.conf
        copy ygopro-database-master\locales\ja-JP\strings.conf strings\strings-ja-JP.conf
        copy ygopro-database-master\locales\en-US_mdpro3\strings.conf strings\strings-en-US.conf
        wget https://github.com/Fluorohydride/ygopro/raw/refs/heads/master/lflist.conf
        wget https://github.com/jwyxym/card-pics/releases/download/pics/pics.zip
        unzip pics.zip
        7z a -tzip -mx=9 assets.zip strings info cdb sound textures lflist.conf pics
        cd ..
        copy .ci\assets.zip src-tauri\assets.zip

    - name: Write Rust File
      shell: cmd
      run: |
        xcopy .ci src-tauri /s /Y /e /I
        cd .ci
        python tauri.conf.json.py windows

    - name: NPM Init
      shell: cmd
      run: |
        npm install

    - name: Windows build
      shell: cmd
      run: |
        npm run tauri build
    
    - name: Copy
      shell: cmd
      run: |
        set "found_msi="
        set "found_exe="
        mkdir build

        for %%f in (.\src-tauri\target\release\bundle\msi\*) do (
            if not defined found_msi (
                copy "%%f" ".\build\tauri-ygo-windows.msi"
                set "found_msi=1"
            )
        )

        for %%f in (.\src-tauri\target\release\bundle\nsis\*) do (
            if not defined found_exe (
                copy "%%f" ".\build\tauri-ygo-windows.exe"
                set "found_exe=1"
            )
        )

    - name: Upload File
      uses: actions/upload-artifact@v4
      with:
        name: tauri-ygo-windows.exe
        path: .\build\tauri-ygo-windows.exe

    - name: Upload File
      uses: actions/upload-artifact@v4
      with:
        name: tauri-ygo-windows.msi
        path: .\build\tauri-ygo-windows.msi

    - name: Upload File
      uses: actions/upload-artifact@v4
      with:
        name: tauri-ygo.exe
        path: .\src-tauri\target\release\tauri-ygo.exe

  push-gitcode:
    runs-on: ubuntu-latest
    needs: [build-android, build-windows]

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Git Config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@github.com"

      - name: Set SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gitcode.com >> ~/.ssh/known_hosts

      - name: Push to GitCode
        run: |
          git remote add gitcode git@gitcode.com:jwyxym/tauri-ygo.git
          git fetch gitcode
          git checkout -b gitcode-main gitcode/main
          git merge origin/main
          git push gitcode gitcode-main:main

  create-release:
    needs: [build-android, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: build

      - name: Delete old Release
        run: |
          TAG_NAME=release-latest
          gh release delete "$TAG_NAME" --yes || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old tag
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git fetch --tags
          git tag -d release-latest || true
          git push origin :refs/tags/release-latest || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create tag
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git tag release-latest
          git push origin release-latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-latest
          release_name: release-latest
          draft: false
          prerelease: false

      - name: Upload
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./build/tauri-ygo.apk/tauri-ygo.apk
          asset_name: tauri-ygo.apk
          asset_content_type: application/octet-stream

      - name: Upload
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./build/tauri-ygo-windows.msi/tauri-ygo-windows.msi
          asset_name: tauri-ygo-windows.msi
          asset_content_type: application/octet-stream

      - name: Upload
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./build/tauri-ygo-windows.exe/tauri-ygo-windows.exe
          asset_name: tauri-ygo-windows.exe
          asset_content_type: application/octet-stream

      - name: Upload
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./build/tauri-ygo.exe/tauri-ygo.exe
          asset_name: tauri-ygo.exe
          asset_content_type: application/octet-stream