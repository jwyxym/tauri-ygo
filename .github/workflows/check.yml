name: check tauri-ygo

on:
  push:
    branches-ignore: ['main']

jobs:
  check:
    name: check-${{ matrix.run-on }}-${{ matrix.target }}
    runs-on: ${{ matrix.run-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64
            run-on: windows-latest
          - target: aarch64
            run-on: windows-11-arm
          - target: x86_64
            run-on: macos-latest
          - target: aarch64
            run-on: macos-latest
          - target: x86_64
            run-on: ubuntu-latest
          - target: aarch64
            run-on: ubuntu-24.04-arm

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      if: matrix.target != 'macos-latest'
      with:
        toolchain: 1.88.0

    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      if: matrix.target == 'macos-latest'
      with:
        toolchain: 1.88.0
        target: ${{ matrix.target }}-apple-darwin

    - name: Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: Install system dependencies
      if: ${{ matrix.target == 'ubuntu-latest' || matrix.target == 'ubuntu-24.04-arm' }}
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          librsvg2-dev \
          libglib2.0-dev \
          libcairo2-dev \
          libpango1.0-dev \
          libatk1.0-dev \
          libgdk-pixbuf2.0-dev \
          build-essential \
          libssl-dev \
          pkg-config \
          libgtk-3-dev \
          xdg-utils

    - name: Write Tauri Config
      run: |
        npm run json:dev

    - name: Check
      run: |
        cd src-tauri
        cargo check